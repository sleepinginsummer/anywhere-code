# WSL 网页终端方案设计（方案 A）

## 背景与目标
在 Windows 主机上提供网页终端，实际终端进程运行在 WSL 中并由 tmux 管理。目标：
- 最多 10 个会话
- 断线自动恢复
- 保留上一个终端状态（光标位置、屏幕缓冲）
- 简单账号密码登录（配置文件内）
- 会话名自动生成，可由用户修改，支持使用“最后输入”作为名称

## 架构与组件
- **后端服务（Windows 侧）**：提供 HTTP 登录、会话管理、终端数据通道。
- **WSL + tmux**：创建/附着会话并维持进程生命周期。
- **浏览器端**：使用 xterm.js 渲染终端，负责本地缓冲与光标状态的持久化。

推荐流程：后端通过本机 `ssh` 连接 WSL（或在 WSL 内直接运行服务并暴露端口），使用 tmux 创建/附着会话。前端连接后端的数据通道，渲染输出并在本地缓存终端状态。断线重连时先恢复本地缓存，再 attach 旧会话继续交互，从而达到“回到断开前的光标位置”的体验。

## 数据流与会话管理
1. **登录**：前端提交用户名/密码，后端校验配置文件。
2. **会话列表**：后端读取会话元数据并验证 tmux 会话是否存在。
3. **创建会话**：后端执行 `tmux new-session -d -s <id>`，返回会话信息。
4. **附着会话**：后端执行 `tmux attach -t <id>`，将 stdout/stderr 流式传给前端。
5. **输入处理**：前端输入透传给后端，后端写入 tmux stdin。

会话元数据建议持久化为轻量 JSON（或小型数据库），包含：
- `id`、`name`、`createdAt`、`lastInputSummary`、`lastActiveAt`

会话名策略：
- 初始自动生成（如 `session-YYYYMMDD-HHMMSS`）
- 用户可修改
- 可选策略：用最后输入摘要自动更新（需过滤敏感字符并限制长度）

## 重连与终端状态恢复
- 前端在每次渲染后周期性保存终端状态（屏幕缓冲、光标位置、滚动位置）到 IndexedDB/localStorage。
- 断线后按指数退避重连；重连成功后先恢复本地缓存，再附着 tmux 会话接收输出。
- 若本地缓存缺失，则直接 attach 当前会话输出。

## 安全与访问控制
- 仅提供简单账号密码登录，配置写入项目配置文件。
- 会话操作必须鉴权，限制每个用户的会话归属。
- 建议仅在局域网使用，如需暴露公网则加 HTTPS 和反向代理。

## 错误处理
- 细分错误码：认证失败、会话不存在、会话超限、SSH 失败、tmux 异常等。
- 前端提示可恢复与不可恢复错误；超时后提示用户手动重连。

## 测试建议
- 单元测试：会话创建/删除、超限、改名、最后输入摘要逻辑。
- 集成测试：SSH/tmux 创建与附着、断线重连。
- 前端测试：终端状态缓存与恢复、会话列表与切换。

